<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance Breakdown Report</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <header>
            <div class="flex-column">
                <img id="logo" src="img/logo.png" alt="GWB Logo">
                <h1>Maintenance Breakdown Report</h1>
            </div>
        </header>

        <div class="flex-row">
            <div class="div-button-create-report">
                <a class="button-create-report" href="index.html">Return to home</a>
            </div>

            <div class="div-button-create-report">
                <button class="button-create-report" id="executorChart">Executors</button>
            </div>

            <div class="div-button-create-report">
                <button class="button-create-report" id="executorButton">Line and Machines</button>
            </div>
        </div>
        <div class="center space-top flex-column">
            <h2 id="title-chart"></h2>
            <div id="top_x_div" style="width: 900px; height: 500px;"></div>
        </div>
    </div>

    <!--Load the AJAX API-->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">

        const API_EXECUTOR_URL = 'http://127.0.0.1:8000/api/executor/';
        const API_EXECUTOR_REPORT_URL = 'http://127.0.0.1:8000/api/executorreports/';
        let executors = [];

        document.addEventListener('DOMContentLoaded', function () {
            loadData();
            document.getElementById('executorChart').addEventListener('click', drawStuff);
        });

        async function loadData() {
            try {
                const executorData = await fetchData(API_EXECUTOR_URL);
                executors.push(['', '']);
                createArray(executorData);
                console.log(executors);

                const executorReportData = await fetchData(API_EXECUTOR_REPORT_URL);
                executorReportData.map(transformData);
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        async function fetchData(url) {
            try {
                let response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                return await response.json();
            } catch (error) {
                console.error('Fetch error:', error);
            }
        }

        function createArray(data) {
            data.forEach(item => {
                executors.push([item.name, 0]);
            });
        }

        function transformData(item) {
            executors.find((element) => {
                if (element[0] == item.idExecutor.name) {
                    element[1]++;
                    console.log('element.name: ' + element[0]);
                    console.log('element.quant: ' + element[1]);
                }
            });
        }

        google.charts.load('current', { 'packages': ['bar'] });

        function drawStuff() {

            var data = new google.visualization.arrayToDataTable(executors);

            var options = {
                title: '',
                width: 900,
                legend: { position: 'none' },
                chart: {
                    title: '',
                    subtitle: ''
                },
                axes: {
                    x: {
                        0: { side: 'bottom', label: '' } // Top x-axis.
                    }
                },
                bar: { groupWidth: "90%" }
            };

            var chart = new google.charts.Bar(document.getElementById('top_x_div'));
            document.getElementById("title-chart").innerHTML = 'The number of reports by each executor'
            chart.draw(data, options);
        };
    </script>
</body>

</html>